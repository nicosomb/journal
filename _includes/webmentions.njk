{% set pageUrl = site.siteUrl + page.url %}
{% set normalizedPageUrl = pageUrl | replace('/index.html', '') | replace('.html', '') %}
{% if webmentions and (webmentions[page.url] or webmentions[normalizedPageUrl] or webmentions[pageUrl]) %}
{% set mentions = webmentions[page.url] or webmentions[normalizedPageUrl] or webmentions[pageUrl] %}
{% if mentions and mentions.length > 0 %}
{% set likes = mentions | filterByPropertyIn("wm-property", "like", "like-of") %}
{% set reposts = mentions | filterByPropertyIn("wm-property", "repost", "repost-of") %}
{% set replies = mentions | filterByProperty("wm-property", "reply") %}
{% set others = mentions | filterByPropertyNot("wm-property", "like", "like-of", "repost", "repost-of", "reply") %}
<section class="webmentions" id="webmentions">
    <h2>R√©actions</h2>
    
    {% if likes | length > 0 %}
    <div class="webmentions-group">
        <h3 class="webmentions-group-title">
            <span class="webmention-icon webmention-icon-like">‚ù§Ô∏è</span>
            {{ likes | length }} {% if likes | length > 1 %}likes{% else %}like{% endif %}
        </h3>
        <ul class="webmentions-list webmentions-list-compact">
            {% for mention in likes %}
            <li class="webmention webmention-like">
                <article class="webmention-content">
                    {% if mention.author %}
                    <div class="webmention-author">
                        {% if mention.author.photo %}
                        <img src="{{ mention.author.photo }}" alt="{{ mention.author.name }}" class="webmention-avatar" loading="lazy" />
                        {% endif %}
                        <div class="webmention-author-info">
                            <strong class="webmention-author-name">
                                {% if mention.url %}
                                <a href="{{ mention.url }}" rel="noopener noreferrer">{{ mention.author.name }}</a>
                                {% else %}
                                {{ mention.author.name }}
                                {% endif %}
                            </strong>
                        </div>
                    </div>
                    {% endif %}
                </article>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    {% if reposts | length > 0 %}
    <div class="webmentions-group">
        <h3 class="webmentions-group-title">
            <span class="webmention-icon webmention-icon-repost">üîÅ</span>
            {{ reposts | length }} {% if reposts | length > 1 %}reposts{% else %}repost{% endif %}
        </h3>
        <ul class="webmentions-list webmentions-list-compact">
            {% for mention in reposts %}
            <li class="webmention webmention-repost">
                <article class="webmention-content">
                    {% if mention.author %}
                    <div class="webmention-author">
                        {% if mention.author.photo %}
                        <img src="{{ mention.author.photo }}" alt="{{ mention.author.name }}" class="webmention-avatar" loading="lazy" />
                        {% endif %}
                        <div class="webmention-author-info">
                            <strong class="webmention-author-name">
                                {% if mention.url %}
                                <a href="{{ mention.url }}" rel="noopener noreferrer">{{ mention.author.name }}</a>
                                {% else %}
                                {{ mention.author.name }}
                                {% endif %}
                            </strong>
                        </div>
                    </div>
                    {% endif %}
                </article>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    {% if replies | length > 0 %}
    <div class="webmentions-group">
        <h3>R√©ponses</h3>
        <div class="webmentions-group-title webmentions-toggle" data-target="replies">
            <span class="webmention-icon webmention-icon-reply">üí¨</span>
            <span class="webmentions-count">{{ replies | length }} {% if replies | length > 1 %}r√©ponses{% else %}r√©ponse{% endif %}</span>
            <span class="webmentions-toggle-icon">‚ñº</span>
        </div>
        <ul class="webmentions-list webmentions-replies" id="replies">
            {% for mention in replies %}
            <li class="webmention webmention-reply">
                <article class="webmention-content">
                    {% if mention.author %}
                    <div class="webmention-author">
                        {% if mention.author.photo %}
                        <img src="{{ mention.author.photo }}" alt="{{ mention.author.name }}" class="webmention-avatar" loading="lazy" />
                        {% endif %}
                        <div class="webmention-author-info">
                            <strong class="webmention-author-name">
                                {% if mention.url %}
                                <a href="{{ mention.url }}" rel="noopener noreferrer">{{ mention.author.name }}</a>
                                {% else %}
                                {{ mention.author.name }}
                                {% endif %}
                            </strong>
                            {% if mention.published %}
                            <time class="webmention-date" datetime="{{ mention.published }}">
                                {{ mention.published | readableDate }}
                            </time>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if mention.content %}
                    <div class="webmention-text">
                        {% if mention.content.html %}
                            {{ mention.content.html | safe }}
                        {% else %}
                            <p>{{ mention.content.text }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if mention.url %}
                    <a href="{{ mention.url }}" class="webmention-source" rel="noopener noreferrer" title="Voir la source">Source</a>
                    {% endif %}
                </article>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    {% if others | length > 0 %}
    <div class="webmentions-group">
        <ul class="webmentions-list">
            {% for mention in others %}
            <li class="webmention webmention-{{ mention['wm-property'] }}">
                <article class="webmention-content">
                    {% if mention.author %}
                    <div class="webmention-author">
                        {% if mention.author.photo %}
                        <img src="{{ mention.author.photo }}" alt="{{ mention.author.name }}" class="webmention-avatar" loading="lazy" />
                        {% endif %}
                        <div class="webmention-author-info">
                            <strong class="webmention-author-name">
                                {% if mention.url %}
                                <a href="{{ mention.url }}" rel="noopener noreferrer">{{ mention.author.name }}</a>
                                {% else %}
                                {{ mention.author.name }}
                                {% endif %}
                            </strong>
                            {% if mention.published %}
                            <time class="webmention-date" datetime="{{ mention.published }}">
                                {{ mention.published | readableDate }}
                            </time>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if mention.content %}
                    <div class="webmention-text">
                        {% if mention.content.html %}
                            {{ mention.content.html | safe }}
                        {% else %}
                            <p>{{ mention.content.text }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if mention.url %}
                    <a href="{{ mention.url }}" class="webmention-source" rel="noopener noreferrer" title="Voir la source">Source</a>
                    {% endif %}
                </article>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</section>
<hr />
{% endif %}
{% endif %}
