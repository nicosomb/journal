<!DOCTYPE html>
<html lang="{% if html_lang %}{{ html_lang }}{% else %}fr{% endif %}">
<head>
    {% block head %}
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}{{ site.siteName }}{% endblock %}</title>
    <link rel="stylesheet" type="text/css" href="/theme/css/main.css" />
    <link rel="shortcut icon" href="/static/favicon.ico" />
    <link href="{{ site.siteUrl }}/{{ site.feedAllAtom }}" type="application/atom+xml" rel="alternate" title="Flux RSS du {{ site.siteName }}" />
    {% if page.url %}
    {% if site.webmentionDomain %}
    <link rel="webmention" href="https://webmention.io/{{ site.webmentionDomain }}/webmention" />
    <link rel="pingback" href="https://webmention.io/{{ site.webmentionDomain }}/xmlrpc" />
    {% endif %}
    {% block extra_head %}{% endblock extra_head %}
    {% endblock head %}
</head>
<body{% if page.url == '/' or page.url == '/404.html' or page.url == '/archives.html' %} data-pagefind-ignore{% endif %}>
    <header class="entete" data-pagefind-ignore>
        <div class="titre">
            {% if page.url != '/' %}
            <a href="/">Page d'accueil</a>
            {% endif %}
            <button class="mode"><svg class="switch" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
            3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
            13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"></path>
            </svg></button>
        </div>
        <section class="menu">
            <section class="flux">
                <h2>Derniers billets</h2>
                <ul>
                    {% for article in collections.billets | limit(3) %}
                    <li><a href="{{ article.url }}">{{ article.data.title }}</a> ({{ article.date | strftime('%d-%m-%Y') }})</li>
                    {% endfor %}
                    <li class="plus"><a href="/archives.html">les archives</a> ({{ collections.billets | length }} billets)</li>
                    <li class="plus"><a href="#" id="search-link">Recherche</a></li>
                </ul>
            </section>
            <nav class="navigation">
                <h2>Ailleurs</h2>
                    {% if site.social %}
                    <ul>
                        {% for item in site.social %}
                        <li><a href="{{ item.url }}" rel="me">{{ item.name }}</a></li>
                        {% endfor %}
                    </ul>
                    {% endif %}
            </nav>
        </section>
    </header>

    {% block content %}{% endblock %}

    {% if page.url == '/' and photos and photos.length > 0 %}
    <section class="photos">
        <h2>Quelques instantanés</h2>
        <div class="photos-grid">
            {% for photo in photos %}
            <a href="{{ photo.url }}" title="{{ photo.title }}" class="photo-thumbnail">
                <img src="{{ photo.imageUrl }}" alt="{{ photo.title }}" loading="lazy" />
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <footer data-pagefind-ignore>
        <p><a href="{{ site.siteUrl }}/{{ site.feedAllAtom }}">Abonnez-vous au flux Atom</a> pour ne rater aucun article.</p>
        {% if page.url != '/' %}
        <p>{{ site.siteName }}, par <a href="/pages/a-propos.html">{{ site.author }}</a></p>
        {% endif %}
    </footer>

    <script>
        const btn = document.querySelector(".mode");
        const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");
        const currentTheme = localStorage.getItem("theme");
        if (currentTheme === "dark") {
            document.body.classList.toggle("dark");
        } else if (currentTheme === "light") {
            document.body.classList.toggle("light-theme");
        }

        btn.addEventListener("click", function () {
            if (prefersDarkScheme.matches) {
                document.body.classList.toggle("light-theme");
                var theme = document.body.classList.contains("light-theme")
                    ? "light"
                    : "dark";
            } else {
                document.body.classList.toggle("dark");
                var theme = document.body.classList.contains("dark")
                    ? "dark"
                    : "light";
            }
            localStorage.setItem("theme", theme);
        });
    </script>
    <div id="search"></div>
    <script src="/_pagefind/pagefind-ui.js" type="text/javascript"></script>
    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            const searchElement = document.getElementById('search');
            
            const pagefindUI = new PagefindUI({
                element: "#search",
                showSubResults: true,
                showImages: false,
                translations: {
                    placeholder: "Rechercher...",
                    clear_search: "Effacer",
                    load_more: "Charger plus de résultats",
                    search_label: "Recherche sur ce site",
                    filters_label: "Filtres",
                    zero_results: "Aucun résultat pour [SEARCH_TERM]",
                    many_results: "[COUNT] résultats pour [SEARCH_TERM]",
                    one_result: "[COUNT] résultat pour [SEARCH_TERM]",
                    alt_search: "Aucun résultat pour [SEARCH_TERM]. Afficher les résultats pour [DIFFERENT_TERM] à la place",
                    search_suggestion: "Aucun résultat pour [SEARCH_TERM]. Essayer l'une de ces recherches:",
                    searching: "Recherche de [SEARCH_TERM]...",
                    shortcut: "Appuyer sur / pour rechercher"
                }
            });
            
            // Ajouter le lien "Fermer" à côté du bouton "Effacer"
            function addCloseLink() {
                // Chercher le bouton "Effacer" de différentes manières
                const clearButton = searchElement.querySelector('button.pagefind-ui__clear-button') ||
                                   searchElement.querySelector('button[aria-label*="Effacer"]') ||
                                   searchElement.querySelector('button[aria-label*="clear"]') ||
                                   Array.from(searchElement.querySelectorAll('button')).find(btn => btn.textContent.includes('Effacer'));
                
                if (clearButton && !document.getElementById('search-close')) {
                    const closeLink = document.createElement('a');
                    closeLink.href = '#';
                    closeLink.id = 'search-close';
                    closeLink.className = 'search-close-link';
                    closeLink.textContent = 'Fermer';
                    closeLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        closeSearch();
                    });
                    // Insérer après le bouton Effacer dans le même conteneur
                    const parent = clearButton.parentNode;
                    if (parent) {
                        parent.insertBefore(closeLink, clearButton.nextSibling);
                    }
                }
            }
            
            // Essayer plusieurs fois car Pagefind peut mettre du temps à créer l'UI
            setTimeout(addCloseLink, 200);
            setTimeout(addCloseLink, 500);
            setTimeout(addCloseLink, 1000);
            
            // Fonction pour ouvrir la recherche
            function openSearch() {
                if (searchElement) {
                    searchElement.setAttribute('data-state', 'open');
                    // Attendre que Pagefind UI soit prêt avant de focus
                    // Essayer plusieurs fois car Pagefind peut mettre du temps à créer le champ
                    const tryFocus = (attempts = 0) => {
                        const searchInput = searchElement.querySelector('input[type="search"]') ||
                                           searchElement.querySelector('input[type="text"]') ||
                                           searchElement.querySelector('.pagefind-ui__search-input');
                        if (searchInput) {
                            searchInput.focus();
                            // Sélectionner le texte si il y en a
                            if (searchInput.value) {
                                searchInput.select();
                            }
                        } else if (attempts < 10) {
                            setTimeout(() => tryFocus(attempts + 1), 100);
                        }
                    };
                    tryFocus();
                }
            }
            
            // Fonction pour fermer la recherche
            function closeSearch() {
                if (searchElement) {
                    searchElement.removeAttribute('data-state');
                    // Réinitialiser le champ de recherche
                    const searchInput = searchElement.querySelector('input[type="search"]');
                    if (searchInput) {
                        searchInput.value = '';
                    }
                }
            }
            
            // Ouvrir la recherche au clic sur le lien
            const searchLink = document.getElementById('search-link');
            if (searchLink) {
                searchLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    openSearch();
                });
            }
            
            // Fermer la recherche au clic sur le bouton de fermeture
            const searchClose = document.getElementById('search-close');
            if (searchClose) {
                searchClose.addEventListener('click', (e) => {
                    e.preventDefault();
                    closeSearch();
                });
            }
            
            // Fermer la recherche en cliquant en dehors de la popin
            if (searchElement) {
                searchElement.addEventListener('click', (e) => {
                    // Si on clique sur le fond (pas sur le contenu)
                    if (e.target === searchElement) {
                        closeSearch();
                    }
                });
                
                // Empêcher la fermeture quand on clique sur le contenu
                const pagefindUI = searchElement.querySelector('.pagefind-ui');
                if (pagefindUI) {
                    pagefindUI.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                }
            }
            
            // Fermer la recherche avec la touche Échap
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && searchElement && searchElement.getAttribute('data-state') === 'open') {
                    closeSearch();
                }
            });
        });
    </script>
</body>
</html>
